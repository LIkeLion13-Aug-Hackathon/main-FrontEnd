// map.js
let courseData = [];
let map;

// === ÏÑ†ÌÉùÎêú ÏΩîÏä§ Î∂àÎü¨Ïò§Í∏∞ ===
async function loadCourseData() {
  const selectedCourseString = localStorage.getItem("selectedCourse");
  if (!selectedCourseString) {
    console.error("localStorageÏóê ÏÑ†ÌÉùÎêú ÏΩîÏä§Í∞Ä ÏóÜÏäµÎãàÎã§.");
    return [];
  }

  let selectedCourse;
  try {
    selectedCourse = JSON.parse(selectedCourseString);
  } catch (err) {
    console.error("ÏΩîÏä§ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå®:", err);
    return [];
  }

  if (!selectedCourse || !Array.isArray(selectedCourse.shops)) {
    console.error("ÏΩîÏä§ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
    return [];
  }

  const fetchPromises = selectedCourse.shops.map(async (shop) => {
    try {
      const shopRes = await fetch(
        `http://54.180.163.161:8080/api/shops/${shop.shopId}`
      );
      if (!shopRes.ok) throw new Error(`Í∞ÄÍ≤å Ï°∞Ìöå Ïã§Ìå®: ${shop.name}`);
      const shopData = await shopRes.json();
      const shopResult = shopData.result || {};

      const menus = Array.isArray(shopResult.menus)
        ? shopResult.menus.map((menu) => ({
            name: menu.name,
            image: menu.imageUrl || "",
            price: menu.price || "Í∞ÄÍ≤© Ï†ïÎ≥¥ ÏóÜÏùå",
            description: menu.description || "",
          }))
        : [];

      return {
        id: shopResult.shopId,
        name: shopResult.name,
        lat: shopResult.yPos,
        lng: shopResult.xPos,
        address: shopResult.location,
        phone: shopResult.phone || "Ï†ïÎ≥¥ ÏóÜÏùå",
        hours: `${shopResult.openTime || "-"} ~ ${shopResult.closeTime || "-"}`,
        image: shopResult.imageUrl || "",
        menus,
      };
    } catch (err) {
      console.error(`[Í∞ÄÍ≤å Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®] ${shop.name}:`, err);
      return null; // Ïã§Ìå® Ïãú null Î∞òÌôò
    }
  });

  const results = await Promise.all(fetchPromises);
  return results.filter((r) => r !== null); // null Ï†úÍ±∞
}

// === ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ===
async function initMap() {
  courseData = await loadCourseData();

  // ‚úÖ URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÏãúÏû• Ïù¥Î¶Ñ ÌôïÏù∏
  const urlParams = new URLSearchParams(window.location.search);
  const marketName = urlParams.get("marketName") || "";

  // ‚úÖ ÎÇ®ÎåÄÎ¨∏ÏãúÏû•Ïùº Í≤ΩÏö∞ Ï§å Î†àÎ≤® Îã§Î•¥Í≤å
  const initialZoom = marketName === "ÎÇ®ÎåÄÎ¨∏ÏãúÏû•" ? 15 : 16.5;

  // ‚úÖ ÏßÄÎèÑ Í∏∞Î≥∏ ÏÑ∏ÌåÖ (ÏΩîÏä§ ÏóÜÏñ¥ÎèÑ Ìï≠ÏÉÅ ÏßÄÎèÑÎäî Îú®Í≤å)
  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.5665, 126.978), // Í∏∞Î≥∏Í∞í: ÏÑúÏö∏ ÏãúÏ≤≠
    zoom: initialZoom,
  });

  if (courseData.length === 0) {
    console.warn("ÏΩîÏä§ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ Í∏∞Î≥∏ ÏßÄÎèÑÎßå ÌëúÏãúÎê©ÎãàÎã§.");

    // ÏΩîÏä§ Ï∂îÏ≤ú Ïù¥Îèô UI ÌëúÏãú
    const headerContainer = document.getElementById("courseBar");
    headerContainer.innerHTML = "";

    const infoDiv = document.createElement("div");
    infoDiv.className = "no-course-info";
    infoDiv.textContent =
      "ÏïÑÏßÅ ÏÑ†ÌÉùÎêú ÏΩîÏä§Í∞Ä ÏóÜÏäµÎãàÎã§. ÏΩîÏä§ Ï∂îÏ≤úÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî!";

    const goBtn = document.createElement("button");
    goBtn.className = "course-btn special-btn";
    goBtn.textContent = "AIÎ°ú Î®πÌÇ∑ ÏΩîÏä§ ÏßúÍ∏∞";
    goBtn.onclick = () => {
      window.location.href = "../preference-page/preference-page.html";
      // üëâ Ïã§Ï†ú ÏΩîÏä§ Ï∂îÏ≤ú ÌéòÏù¥ÏßÄ Í≤ΩÎ°úÎ°ú ÏàòÏ†ïÌï¥
    };

    headerContainer.appendChild(infoDiv);
    headerContainer.appendChild(goBtn);
    return;
  }

  // ‚úÖ ÏΩîÏä§ ÏûàÏùÑ ÎïåÎßå Ï†ïÏÉÅ ÎèôÏûë
  let totalLat = 0;
  let totalLng = 0;
  courseData.forEach((shop) => {
    totalLat += shop.lat;
    totalLng += shop.lng;
  });

  const centerLat = totalLat / courseData.length;
  const centerLng = totalLng / courseData.length;

  map.setCenter(new naver.maps.LatLng(centerLat, centerLng));
  renderCourseButtons();
  renderMarkersAndPath();
}

// === Î≤ÑÌäº ÏÉùÏÑ± ===
function renderCourseButtons() {
  const headerContainer = document.getElementById("courseBar");
  headerContainer.innerHTML = "";

  // ‚úÖ ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ: URL ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÏãúÏû• Ïù¥Î¶ÑÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§.
  const urlParams = new URLSearchParams(window.location.search);

  // ‚úÖ localStorage > URL > Í∏∞Î≥∏Í∞í
  const marketName =
    localStorage.getItem("selectedMarketName") ||
    urlParams.get("marketName") ||
    "ÏÑ†ÌÉùÎêú ÏãúÏû•";

  const specialBtn = document.createElement("button");
  specialBtn.className = "course-btn special-btn";
  specialBtn.textContent = marketName;

  specialBtn.onclick = () => {
    if (courseData.length > 0) {
      moveToLocation(courseData[0].lat, courseData[0].lng);
    }
  };
  headerContainer.appendChild(specialBtn);

  courseData.forEach((store, index) => {
    const btn = document.createElement("button");
    btn.className = "course-btn";

    const pinImg = document.createElement("img");
    pinImg.src = "../map-page/map_asset/red-pin.png";
    pinImg.alt = "Red Pin";
    pinImg.className = "pin-icon";

    const textSpan = document.createElement("span");
    textSpan.textContent = store.name;

    btn.appendChild(pinImg);
    btn.appendChild(textSpan);

    btn.onclick = () => {
      moveToLocation(store.lat, store.lng);
      showDetailPanel(store);
    };
    headerContainer.appendChild(btn);

    if (index < courseData.length - 1) {
      const arrowImg = document.createElement("img");
      arrowImg.src = "../map-page/map_asset/map-arrow.png";
      arrowImg.alt = "Arrow";
      arrowImg.className = "arrow-icon";
      headerContainer.appendChild(arrowImg);
    }
  });
}

// === Í±∞Î¶¨ Í≥ÑÏÇ∞ ===
function distance(lat1, lng1, lat2, lng2) {
  const R = 6371e3;
  const toRad = (x) => (x * Math.PI) / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLng / 2) *
      Math.sin(dLng / 2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// === ÎßàÏª§ + ÎùºÎ≤® Í≤πÏπ® Î∞©ÏßÄ + Í≤ΩÎ°ú + ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ===
async function renderMarkersAndPath() {
  const positions = [];
  const labelBounds = [];
  const projection = map.getProjection();

  function isOverlapping(a, b) {
    return !(
      a.right < b.left ||
      a.left > b.right ||
      a.bottom < b.top ||
      a.top > b.bottom
    );
  }

  courseData.forEach((store) => {
    const position = new naver.maps.LatLng(store.lat, store.lng);
    positions.push({ position, store });

    const marker = new naver.maps.Marker({
      position,
      map,
      icon: {
        url: "../map-page/map_asset/map-pin.png",
        size: new naver.maps.Size(32, 48),
        scaledSize: new naver.maps.Size(20, 48),
        anchor: new naver.maps.Point(16, 32),
      },
      title: store.name,
    });

    const labelText = store.name;

    const directions = [
      { x: 10, y: -45, className: "right" },
      { x: -60, y: -80, className: "top" },
      { x: -50, y: 20, className: "bottom" },
      { x: -160, y: -25, className: "left" },
    ];

    let chosen = directions[0];
    const point = projection.fromCoordToOffset(position);

    for (let dir of directions) {
      const newBox = {
        left: point.x + dir.x,
        right: point.x + dir.x + 120,
        top: point.y + dir.y,
        bottom: point.y + dir.y + 40,
      };
      const overlap = labelBounds.some((box) => isOverlapping(newBox, box));
      if (!overlap) {
        chosen = dir;
        labelBounds.push(newBox);
        break;
      }
    }

    const labelDiv = new naver.maps.Marker({
      position,
      map,
      icon: {
        content: `
          <div class="marker-label-container ${chosen.className}"
               style="transform: translate(${chosen.x}px, ${chosen.y}px);">
               ${labelText}
          </div>
        `,
        anchor: new naver.maps.Point(0, 0),
      },
    });

    naver.maps.Event.addListener(marker, "click", function () {
      showDetailPanel(store);
    });
    naver.maps.Event.addListener(labelDiv, "click", function () {
      showDetailPanel(store);
    });
  });

  // === Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞ ===
  if (positions.length >= 2) {
    let mergedPath = [];

    for (let i = 0; i < positions.length - 1; i++) {
      const start = positions[i].position;
      const end = positions[i + 1].position;

      try {
        const url = new URL("http://54.180.163.161:8080/api/directions");
        url.searchParams.set("alat", start.lat());
        url.searchParams.set("alng", start.lng());
        url.searchParams.set("blat", end.lat());
        url.searchParams.set("blng", end.lng());
        url.searchParams.set("priority", "RECOMMEND");

        const res = await fetch(url);
        const data = await res.json();

        if (data.path && Array.isArray(data.path) && data.path.length > 0) {
          const segmentPath = data.path.map(
            ([lat, lng]) => new naver.maps.LatLng(lat, lng)
          );

          if (i === 0) mergedPath.push(start);

          for (let pt of segmentPath) {
            const last = mergedPath[mergedPath.length - 1];
            if (
              !last ||
              pt.lat().toFixed(6) !== last.lat().toFixed(6) ||
              pt.lng().toFixed(6) !== last.lng().toFixed(6)
            ) {
              mergedPath.push(pt);
            }
          }

          if (i === positions.length - 2) mergedPath.push(end);
        }
      } catch (error) {
        console.error(`${positions[i + 1].store.name} Í∏∏Ï∞æÍ∏∞ Ïò§Î•ò:`, error);
      }
    }

    if (mergedPath.length > 1) {
      new naver.maps.Polyline({
        map,
        path: mergedPath,
        strokeWeight: 3,
        strokeColor: "#FF0013",
        strokeOpacity: 0.9,
        strokeStyle: "solid",
        strokeLineCap: "round",
        strokeLineJoin: "round",
      });
    }
  }
}
// === ÏÉÅÏÑ∏ Ìå®ÎÑê ===
async function showDetailPanel(data) {
  document.getElementById("storeName").textContent = data.name;
  document.getElementById("storeAddr").textContent = data.address;
  document.getElementById("storeTime").textContent = data.hours;
  document.getElementById("storePhone").textContent = data.phone;

  const menuContainer = document.getElementById("storeImages");
  menuContainer.innerHTML = "<p>Î©îÎâ¥ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>";

  try {
    // Î©îÎâ¥ API Ìò∏Ï∂ú
    const res = await fetch(
      `http://54.180.163.161:8080/api/shops/${data.id}/menus`
    );
    if (!res.ok) throw new Error("Î©îÎâ¥ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®");
    const menuData = await res.json();

    const menuList = menuData.result?.menuPreviewList || [];

    if (menuList.length === 0) {
      menuContainer.innerHTML = "<p>Îì±Î°ùÎêú Î©îÎâ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>";
    } else {
      menuContainer.innerHTML = "";

      // Î©îÎâ¥Í∞Ä 4Í∞ú Ïù¥ÏÉÅÏùº ÎïåÎäî 3Í∞úÍπåÏßÄÎßå Ï∂úÎ†•
      const limitedMenuList = menuList.slice(0, 3);

      limitedMenuList.forEach((menu) => {
        const menuItem = document.createElement("div");
        menuItem.className = "menu-item";

        const priceText =
          typeof menu.price === "number"
            ? `${menu.price.toLocaleString()}Ïõê`
            : menu.price || "";

        let imageContent = "";
        if (menu.ImageUrl && menu.ImageUrl.trim() !== "") {
          imageContent = `<img src="${menu.ImageUrl}" alt="${menu.name}" class="menu-image"/>`;
        } else {
          imageContent = `<div class="no-image">Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</div>`;
        }

        menuItem.innerHTML = `
    ${imageContent}
    <div class="menu-details">
      <div class="menu-name">${menu.name}</div>
      <div class="menu-price">${priceText}</div>
    </div>
  `;

        menuContainer.appendChild(menuItem);
      });
    }
  } catch (err) {
    console.error("Î©îÎâ¥ Î°úÎî© Ïò§Î•ò:", err);
    menuContainer.innerHTML = "<p>Î©îÎâ¥ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</p>";
  }

  document.getElementById("detailPanel").style.display = "flex";
}

// Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById("closePanel").onclick = function () {
  document.getElementById("detailPanel").style.display = "none";
};

// ÏßÄÎèÑ Ïù¥Îèô Ìï®Ïàò
function moveToLocation(lat, lng) {
  map.setCenter(new naver.maps.LatLng(lat, lng));
}

// Ïù¥ Ìï®ÏàòÎäî ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏúºÎØÄÎ°ú Ï†úÍ±∞ÌïòÍ±∞ÎÇò Í∑∏ÎåÄÎ°ú Îë°ÎãàÎã§.
async function openStoreDetail(shopId) {
  console.error(
    "openStoreDetail Ìï®ÏàòÎäî Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏäµÎãàÎã§. showDetailPanelÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî."
  );
}

// Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Î°úÎìúÎêòÎ©¥ ÏßÄÎèÑ Ï¥àÍ∏∞ÌôîÎ•º Ïã§ÌñâÌï©ÎãàÎã§.
window.onload = initMap;
